{
  "schemaVersion": "0.3",
  "description": "Golden image automation",
  "parameters": {
    "instanceId": {
      "type": "String",
      "description": "Golden image server instanceId"
    },
    "platform": {
      "type": "String",
      "description": "Operating sytem platform (windows | linux )",
      "default": "windows"
    }
  },
  "mainSteps": [
    {
      "name": "prepareInstance",
      "action": "aws:branch",
      "inputs": {
        "Choices": [
          {
            "NextStep": "runSysprepForWindows",
            "Variable": "{{platform}}",
            "StringEquals": "windows"
          }
        ],
        "Default": "createImage"
      }
    },
    {
      "name": "runSysprepForWindows",
      "action": "aws:runCommand",
      "inputs": {
        "DocumentName": "AWSEC2-RunSysprep",
        "InstanceIds": [
          "{{instanceId}}"
        ]
      },
      "nextStep": "waitForSysprep"
    },
    {
      "name": "waitForSysprep",
      "action": "aws:sleep",
      "inputs": {
        "Duration": "PT1M"
      },
      "nextStep": "createImage"
    },
    {
      "name": "createImage",
      "action": "aws:executeAutomation",
      "maxAttempts": 3,
      "timeoutSeconds": 3600,
      "onFailure": "Abort",
      "inputs": {
        "DocumentName": "AWS-CreateImage",
        "RuntimeParameters": {
          "InstanceId": "{{instanceId}}"
        }
      }
    }
  ]
}