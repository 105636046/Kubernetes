{
    "description": "Linux Antivirus Update Automation",
    "schemaVersion": "0.3",
    "mainSteps": [
        {
            "name": "linuxInstances",
            "action": "aws:executeAwsApi",
            "onFailure": "Abort",
            "inputs": {
                "Service": "ec2",
                "Api": "DescribeInstances",
                "Filters": [{
                        "Name": "instance-state-name",
                        "Values": [
                            "stopped"
                        ]
                    },
                    {
                        "Name": "tag:os_type",
                        "Values": [
                            "RedHat*",
                            "AmazonLinux*",
                            "CentOS*",
                            "Ubuntu*"
                        ]
                    },
                    {
                        "Name": "block-device-mapping.status",
                        "Values": [
                            "attached"
                        ]
                    }
                ]
            },
            "outputs": [{
                "Name": "instanceIds",
                "Selector": "$.Reservations..Instances..InstanceId",
                "Type": "StringList"
            }]
        },
        {
            "name": "startInstances",
            "action": "aws:changeInstanceState",
            "maxAttempts": 3,
            "timeoutSeconds": 3600,
            "onFailure": "Abort",
            "inputs": {
                "InstanceIds": [
                    "{{linuxInstances.instanceIds}}"
                ],
                "DesiredState": "running"
            }
        },
        {
            "name": "updateAntivirus",
            "action": "aws:runCommand",
            "maxAttempts": 3,
            "onFailure": "Continue",
            "inputs": {
                "DocumentName": "AWS-RunShellScript",
                "InstanceIds": ["{{linuxInstances.instanceIds}}"],
                "Parameters": {
                    "commands": [
                        "/opt/McAfee/agent/bin/cmdagent -c\n"
                    ]
                }
            }
        },
        {
            "name":"waitForAntivirusUpdate",
            "action":"aws:sleep",
            "inputs":{
               "Duration":"PT1M"
            }
         },
        {
            "name": "stopInstances",
            "action": "aws:changeInstanceState",
            "maxAttempts": 3,
            "timeoutSeconds": 3600,
            "onFailure": "Abort",
            "inputs": {
                "InstanceIds": [
                    "{{linuxInstances.instanceIds}}"
                ],
                "DesiredState": "stopped"
            },
            "isEnd": true
        }
    ]
}